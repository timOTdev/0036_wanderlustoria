<% include headerPartial %>

<nav class="navbar navbar-expand-lg justify-content-between my-0 py-1 text-center" style="background: black;">
  <div class="py-1" aria-label="breadcrumb">
      <a class="btn btn-outline-secondary py-0" href="/cities">Cities</a>
      <a class="btn btn-outline-secondary py-0" href="/cities/<%= city._id %>"><%= city.name %>, <%= city.country %></a>
      <a class="btn btn-outline-light py-0" href="/cities/<%= city._id %>/stories/<%= story._id %>"><%= story.location.name %></a>
  </div> 
  <div class="py-1">
    <% if (currentUser && story.author.id.equals(currentUser._id) || currentUser && currentUser.isAdmin){ %>
      <a class="btn btn-warning py-0" href="/cities/<%= city._id %>/stories/<%= story._id %>/edit">Edit</a>
      <form class="btn btn-danger p-0" 
      id="delete" 
      action="/cities/<%= city._id%>/stories/<%= story._id %>?_method=DELETE" 
      method="POST" 
      onsubmit="return confirm('Delete <%= story.title %>?');">
        <button type="submit" class="btn btn-danger btn-transparent py-0">Delete</button>
      </form>
    <% } %>
  </div>
</nav>

<div class="jumbotron mx-0 mb-0 p-0">
  <div class="row mx-0">
    <div class="col-lg-3 col-md-6 col-sm-12 my-1 py-1" id="map" style="height: 90vh; width: 100%; border: 2px solid black; border-radius: 5%;">
    </div>

    <div class="col-lg-6 col-md-6 col-sm-12 my-1 py-1 text-center">
      <h1><%= story.title.toUpperCase() %></h1>
      <h5><em><%= story.location.name %> @ <%= story.location.city %>, <%= story.location.country %></em></h5>
      <hr class="w-100">
      <img class="img-fluid" src="<%= story.image.name %>" alt="<%= story.title %>" />
      <p><em><%= story.date %></em></p>
      <p class="w-100 mx-auto"><%= story.body %></p>
      <p>Submitted by: <a href="/users/<%= story.author.id %>"><%= story.author.name %></a></p>
    </div>

    <div class="col-lg-3 col-md-6 col-sm-12 my-1 py-1" style="height: 90vh; border: 2px solid black; border-radius: 5%;">
      <% story.comments.forEach(function(comment){ %>
        <hr class="w-100">
        <div class="comment">
          <p class="d-inline">
            <a href="/users/<%= comment.author.id %>">
              <strong><%= comment.author.username %></strong></a>: <%= comment.body %>
          </p>

          <% if (currentUser && comment.author.id.equals(currentUser._id) || currentUser && currentUser.isAdmin){ %>
            <a class="d-inline-block" href="/cities/<%= city._id %>/stories/<%= story._id %>/comments/<%= comment._id %>/edit">
              <button class="btn btn-warning p-1">
                  <i class="fas fa-edit"></i>
              </button>
            </a>
            
            <form class="d-inline-block" id="delete" action="/cities/<%= city._id %>/stories/<%= story._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
              <button class="btn btn-danger p-1" onclick="return confirm('Delete comment?');">
                  <i class="fas fa-trash-alt"></i>
              </button>
            </form>
          <% } %>
        </div>
        <% }) %>

        <hr class="w-100">

        <form action="/cities/<%= city._id %>/stories/<%= story._id%>" method="POST">
          <div class="form-group">
              <textarea class="form-control w-100" type="text" name="comment[body]" placeholder="Comment" required></textarea>
          </div>
          <button class="btn btn-success d-block mx-auto" type="submit" style="margin: 1rem 0;">Add Comment</button>
        </form>
    </div>
  </div>
</div>

<script>
  function initMap() {
    var lat = <%= story.location.latitude %>;
    var lng = <%= story.location.longitude %>;
    var center = {lat: lat, lng: lng };
    var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 8,
        center: center,
        scrollwheel: false
    });
    var contentString = `
        <p style="text-align: left;"><strong><%= story.location.name %></strong></p>
        <p style="text-align: left;"><%= story.location.city %>, <%= story.location.country %></p>
    `
    var infowindow = new google.maps.InfoWindow({
      content: contentString
    });
    var marker = new google.maps.Marker({
        position: center,
        map: map
    });
    marker.addListener('click', function() {
      infowindow.open(map, marker);
    });
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD388n3Ic5C826_Hoi60v_eCJMwaAlfDs4&callback=initMap"></script>

<% include footerPartial %>
